<ion-app>
  <!-- Menu latéral -->

  <ion-menu contentId="main-content">
    <ion-header>
      <ion-toolbar color="tertiary">
        <ion-title>SUPMAP</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <ion-button expand="full" color="primary" routerLink="/signalisation">
        Signalement
      </ion-button>
      <ion-button expand="full" color="secondary" routerLink="/gestion">
        Gestion des itineraire
      </ion-button>
      <ion-button expand="full" color="secondary" routerLink="/ami">
        Amis
      </ion-button>
      <ion-button expand="full" color="secondary" routerLink="/signal">
        Validation des signalement
      </ion-button>
      <ion-button expand="full" color="secondary" routerLink="/partage">
        Partage des itineraire
      </ion-button>
      <ion-button expand="full" color="secondary" routerLink="/mes-signalements">
        Mes signalements
      </ion-button>
    </ion-content>
  </ion-menu>

  <!-- Page principale -->
  <div class="ion-page" id="main-content">
    <!-- Header -->
    <ion-header [translucent]="true">
      <ion-toolbar>
        <!-- Bouton pour ouvrir le menu -->
        <ion-buttons slot="start">
          <ion-menu-button></ion-menu-button>
        </ion-buttons>

        <ion-label class="welcome-text">
          Bienvenue {{ userName }}
        </ion-label>


        <ion-buttons slot="end">
          <!-- Notifications (cloche) -->
  <ion-button (click)="openNotificationPopover($event)">
    <ion-icon name="notifications-outline"></ion-icon>
    <ion-badge *ngIf="unreadCount > 0" color="danger" class="notif-badge">
      {{ unreadCount }}
    </ion-badge>

  </ion-button>
  <ion-popover
  [isOpen]="isNotificationPopoverOpen"
  [event]="notificationPopoverEvent"
  (didDismiss)="isNotificationPopoverOpen = false">
  <ng-template>
    <ion-content class="ion-padding">
      <ion-list *ngIf="notifications.length; else noAlerts">
        <ion-item *ngFor="let notif of notifications.slice(0, 5)">
          <ion-label>
            <h3>{{ notif.type }}</h3>
            <p>{{ notif.description }}</p>
            <p>{{ notif.distance }} km</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <ng-template #noAlerts>
        <ion-label>Aucune alerte récente.</ion-label>
      </ng-template>
    </ion-content>
  </ng-template>
</ion-popover>

  <!-- Demandes d'amis -->
  <ion-button (click)="openFriendRequestPopover($event)">
    <ion-icon name="people-outline"></ion-icon>
    <ion-badge *ngIf="unreadCount > 0" color="danger" class="notif-badge">
      {{ unreadCount }}
    </ion-badge>
  </ion-button>
  <ion-popover [isOpen]="isFriendPopoverOpen" [event]="friendPopoverEvent" (didDismiss)="isFriendPopoverOpen = false">
    <ng-template>
      <ion-content class="ion-padding">
        <ion-list *ngIf="friendRequests.length > 0; else noRequest">
          <ion-item *ngFor="let request of friendRequests">
            <ion-label>{{ request.sender.name }}</ion-label>
            <ion-button color="success" size="small" (click)="acceptFriend(request.id)">
              Accepter
            </ion-button>
          </ion-item>
        </ion-list>
        <ng-template #noRequest>
          <ion-label>Aucune demande d'ami</ion-label>
        </ng-template>
      </ion-content>
    </ng-template>
  </ion-popover>
          <ion-button (click)="openMenu($event)">
            <ion-icon slot="icon-only" name="person-circle-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>



    <ion-popover [isOpen]="isPopoverOpen" [event]="popoverEvent" (didDismiss)="isPopoverOpen = false">
      <ng-template>
        <ion-content class="ion-padding">
          <ion-list>
            <ion-item (click)="goToProfile()">
              <ion-icon name="person-outline" slot="start"></ion-icon>
              <ion-label>Profil</ion-label>
            </ion-item>
            <ion-item (click)="goToSettings()">
              <ion-icon name="settings-outline" slot="start"></ion-icon>
              <ion-label>Paramètres</ion-label>
            </ion-item>
            <ion-item (click)="toggleDarkMode()">
              <ion-icon name="moon-outline" slot="start"></ion-icon>
              <ion-label>Mode Sombre</ion-label>
            </ion-item>
            <ion-item (click)="logout()">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              <ion-label>Déconnexion</ion-label>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>





    <!-- Contenu principal -->
    <ion-content [fullscreen]="true">
      <ion-header collapse="condense">
        <ion-toolbar>
          <ion-title size="large">Itinéraire</ion-title>
        </ion-toolbar>
      </ion-header>

      <!-- Contenu de la page -->
      <div class="maps-container">
        <div id="map"></div>
      </div>

      <div class="form-container">
        <form (ngSubmit)="calculateRoute()">

          <!-- Champ de départ -->
          <ion-item>
            <ion-label position="floating">Point de départ</ion-label>
            <ion-input [(ngModel)]="startPoint" (ionInput)="onCityInputChanged($event, 'start')" name="start"
              autocomplete="off"></ion-input>

            <!-- Bouton icône de géolocalisation -->
            <ion-buttons slot="end">
              <ion-button fill="clear" (click)="useCurrentLocation()">
                <ion-icon name="locate-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-item>

          <!-- Suggestions pour départ -->
          <ion-list *ngIf="citySuggestions.length && inputTarget === 'start'">
            <ion-item *ngFor="let city of citySuggestions | slice:0:5" (click)="selectSuggestedCity(city)">
              {{ city }}
            </ion-item>
          </ion-list>

          <!-- Champ de destination -->
          <ion-item>
            <ion-label position="floating">Destination</ion-label>
            <ion-input [(ngModel)]="endPoint" (ionInput)="onCityInputChanged($event, 'end')" name="end"
              autocomplete="off">
            </ion-input>
          </ion-item>

          <!-- Suggestions pour destination -->
          <ion-list *ngIf="citySuggestions.length && inputTarget === 'end'">
            <ion-item *ngFor="let city of citySuggestions | slice:0:5" (click)="selectSuggestedCity(city)">
              {{ city }}
            </ion-item>
          </ion-list>

          <!-- Bouton -->
          <ion-button expand="block" type="submit">
            Calculer l'itinéraire
          </ion-button>
        </form>
      </div>
    </ion-content>
  </div>
</ion-app>
